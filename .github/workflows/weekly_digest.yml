name: Weekly Claude Digest

on:
  schedule:
    - cron: '0 6 * * 1'   # ogni luned√¨ alle 06:00 UTC (08:00 ora italiana)
  workflow_dispatch:        # run manuale dal sito GitHub (tasto "Run workflow")

jobs:
  digest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Scarica il codice del repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Installa Python 3.12
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # 3. Installa dipendenze
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Autentica Google Cloud con Service Account
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 5. Scarica gli articoli degli ultimi 7 giorni (senza email)
      - name: Fetch 7-day GDELT data
        run: |
          python gdelt_pipeline.py \
            --config config.actions.json \
            --auto-dates \
            --days 7

      # 6. Genera la rassegna stampa con Claude API e invia per email
      - name: Generate digest with Claude + send email
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        run: |
          python generate_digest.py \
            --data-dir data \
            --output-dir posts \
            --send-email \
            --email-to n.barban@unibo.it

      # 7. Commit automatico del post in posts/
      - name: Commit digest
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions Bot"
          git add data/ posts/
          git diff --staged --quiet || git commit -m "Weekly digest $(date -u +%Y-%m-%d)"
          git push
