name: Weekly Claude Digest

on:
  schedule:
    - cron: '0 6 * * 1'   # ogni luned√¨ alle 06:00 UTC (08:00 ora italiana)
  workflow_dispatch:        # run manuale dal sito GitHub (tasto "Run workflow")

jobs:
  digest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Scarica il codice del repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Installa Python 3.12
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # 3. Installa dipendenze
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Autentica Google Cloud con Service Account
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 5a. Scarica gli articoli degli ultimi 7 giorni da GDELT
      - name: Fetch 7-day GDELT data
        run: |
          python gdelt_pipeline.py \
            --config config.actions.json \
            --auto-dates \
            --days 7

      # 5b. Scarica articoli italiani da NewsData.io (ultime 48h, grandi quotidiani)
      - name: Fetch NewsData.io articles
        env:
          NEWSDATA_API_KEY: ${{ secrets.NEWSDATA_API_KEY }}
        run: python newsdata_pipeline.py --output-dir data --timeframe 48

      # 6. Genera la rassegna stampa con Claude API (merge GDELT + NewsData) e invia per email
      - name: Generate digest with Claude + send email
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        run: |
          python generate_digest.py \
            --data-dir data \
            --output-dir posts \
            --send-email \
            --email-to n.barban@unibo.it

      # 7. Commit automatico del post in data/ e posts/
      - name: Commit digest to main
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions Bot"
          git add data/ posts/
          git diff --staged --quiet || git commit -m "Weekly digest $(date -u +%Y-%m-%d)"
          git push

      # 8. Pubblica il post sul blog DemoRumors (branch gh-pages)
      - name: Publish to DemoRumors blog (gh-pages)
        run: |
          DATE=$(date -u +%Y-%m-%d)
          LATEST=$(ls -t posts/*_digest.md | head -1)

          # Crea il post Jekyll con front matter (usa Python per gestire caratteri speciali)
          python3 - <<PYEOF
          import pathlib, textwrap

          date = "$DATE"
          src  = pathlib.Path("$LATEST").read_text(encoding="utf-8")
          lines = src.split("\n")

          title = lines[0].lstrip("# ").strip() if lines and lines[0].startswith("# ") else "Rassegna Stampa"
          title_esc = title.replace('"', '\\"')
          body = "\n".join(lines[1:]).lstrip("\n")

          front = textwrap.dedent(f"""---
          layout: post
          title: "{title_esc}"
          date: {date}
          ---

          """)

          pathlib.Path("/tmp/jekyll_post.md").write_text(front + body, encoding="utf-8")
          print(f"Jekyll post created: {title}")
          PYEOF

          # Passa a gh-pages, copia il post, committa e torna a main
          git fetch origin gh-pages
          git checkout gh-pages

          cp /tmp/jekyll_post.md "_posts/${DATE}-digest.md"

          git add "_posts/${DATE}-digest.md"
          git diff --staged --quiet || git commit -m "Add weekly digest ${DATE}"
          git push origin gh-pages

          git checkout main
